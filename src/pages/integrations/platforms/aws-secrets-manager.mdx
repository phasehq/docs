import { Tag } from '@/components/Tag'

export const description = 'Integrate Phase with AWS Secrets Manager'

<Tag variant="small">INTEGRATE</Tag>

# AWS Secrets Manager

You can use Phase to sync secrets to your AWS infrastructure via AWS Secrets Manager.

### Prerequisites

- AWS CLI / AWS CloudShell
- An AWS account with permissions to create IAM users and attach policies

<Warning>
  When secret syncing is enabled, secrets stored inside Phase will be treated as
  a source of truth. Any secrets on target service will be overwritten /
  deleted. Please import your secrets in Phase before continuing. See: [Import
  secrets from AWS Secrets
  Manager](/integrations/platforms/aws-secrets-manager#optional-import-existing-secrets-from-aws-secrets-manager-in-phase)
</Warning>

**Note**: If you don't have `aws-cli` installed locally on your system you can AWS CloudShell by logging in to your AWS Console and clicking the terminal icon in the top left.

![aws-cloudshell](/assets/images/platform-integrations/aws/aws-cloudshell-enable.png)

## Step 1: Create the IAM Policy

1. **Run the following command**, feel free to replace `phase-console-aws-secrets-manager-integration-policy` with a unique name for your policy:

```fish
aws iam create-policy --policy-name phase-console-aws-secrets-manager-integration-policy --policy-document "$(cat <<EOF
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowSecretsManagerAccess",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret",
        "secretsmanager:PutSecretValue",
        "secretsmanager:ListSecrets",
        "secretsmanager:CreateSecret",
        "secretsmanager:DeleteSecret",
        "secretsmanager:TagResource",
        "secretsmanager:UpdateSecret"
      ],
      "Resource": "*"
    }
  ]
}
EOF
)"
```

Note: This policy assumes you want to encrypt secrets in AWS Secrets Manager using AWS Managed Keys. If you want to encrypt secrets with self managed keys you can follow:

[Encrypt secrets in AWS Secrets Manager with AWS KMS customer managed keys (CMK)](/integrations/platforms/aws-secrets-manager#advanced-encrypt-secrets-in-aws-secrets-manager-with-aws-kms-customer-managed-keys-cmk)

2. **Make a note of the `Arn` returned**

Example:

```json
{
  "Policy": {
    "PolicyName": "phase-console-aws-secrets-manager-integration-policy",
    "PolicyId": "ANPAXITFTPXYBNMGGOJLTMQ",
    "Arn": "arn:aws:iam::012345678910:policy/phase-console-aws-secrets-manager-integration-policy",
    "Path": "/",
    "DefaultVersionId": "v1",
    "AttachmentCount": 0,
    "PermissionsBoundaryUsageCount": 0,
    "IsAttachable": true,
    "CreateDate": "2024-01-04T07:55:01+00:00",
    "UpdateDate": "2024-01-04T07:55:01+00:00"
  }
}
```

## Step 2: Create the IAM User

1. **To create a new IAM user**, feel free to replace `phase-console-aws-secrets-manager-integration` with the desired username, and run:

```fish
aws iam create-user --user-name phase-console-aws-secrets-manager-integration
```

Example:

```json
{
  "User": {
    "Path": "/",
    "UserName": "phase-console-aws-secrets-manager-integration",
    "UserId": "ANPAXITFTPXYBSDAAGOJLTMQ",
    "Arn": "arn:aws:iam::012345678910:user/phase-console-aws-secrets-manager-integration",
    "CreateDate": "2024-01-04T07:55:01+00:00"
  }
}
```

## Step 3: Attach the Policy to the User

1. **Attach the policy to the user** using the Policy ARN returned from Step 1. Replace `[POLICY_ARN]` and `phase-console-aws-secrets-manager-integration` accordingly:

```fish
aws iam attach-user-policy --user-name phase-console-aws-secrets-manager-integration --policy-arn [POLICY_ARN]
```

Example:

```fish
aws iam attach-user-policy --user-name phase-console-aws-secrets-manager-integration --policy-arn arn:aws:iam::012345678910:policy/phase-console-aws-secrets-manager-integration-policy
```

## Step 4: (Optional) Tag the User

1. **To keep things organized, add tags to the user**. Replace `phase-console-aws-secrets-manager-integration` and add key-value pairs for the tags:

```fish
aws iam tag-user --user-name phase-console-aws-secrets-manager-integration --tags Key=Phase,Value=PhaseConsoleIntegrations
```

## Step 5: Create Access Keys

1. **If the user needs programmatic access**, such as for using the AWS CLI, create access keys:

```fish
aws iam create-access-key --user-name phase-console-aws-secrets-manager-integration
```

Example:

```json
{
  "AccessKey": {
    "UserName": "phase-console-aws-secrets-manager-integration",
    "AccessKeyId": "AKIAQYLPMN5HKFHC6LJC",
    "Status": "Active",
    "SecretAccessKey": "6hsRAkFgIpblo04Bx1+lIW1NHVbXgovLhgJFsIts",
    "CreateDate": "2024-01-04T07:55:01+00:00"
  }
}
```

## Optional: Import existing secrets from AWS Secrets Manager in Phase

1. List secrets

```fish
aws secretsmanager list-secrets
```

Example output:

```json
{
  "SecretList": [
    {
      "ARN": "arn:aws:secretsmanager:eu-central-1:012345678910:secret:demo-secret-meQFRh",
      "Name": "demo-secret",
      "LastChangedDate": "2024-01-04T07:55:01+00:00",
      "LastAccessedDate": "2024-01-04T07:55:01+00:00",
      "SecretVersionsToStages": {
        "ade6d1a4-5bf8-4759-8d07-65c83e3601c8": ["AWSPREVIOUS"],
        "edb1bc97-69b9-485c-9a26-571a4825b69f": ["AWSCURRENT"]
      },
      "CreatedDate": "2024-01-04T07:55:01+00:00"
    }
  ]
}
```

2. Export secrets to a `.env` file

```fish
aws secretsmanager get-secret-value --secret-id demo-secret | \
jq -r '.SecretString | fromjson | to_entries | map("\(.key)=\(.value|tostring)")[]' > .env
```

Example output:

```fish
head .env
SECRET_KEY_1=dummy_value_1
SECRET_KEY_2=dummy_value_2
SECRET_KEY_3=dummy_value_3
SECRET_KEY_4=dummy_value_4
SECRET_KEY_5=dummy_value_5
SECRET_KEY_6=dummy_value_6
SECRET_KEY_7=dummy_value_7
SECRET_KEY_8=dummy_value_8
SECRET_KEY_9=dummy_value_9
SECRET_KEY_10=dummy_value_10
```

3. Import secret in Phase via the `phase-cli`

```fish
phase secrets import .env --env development
```

4. Delete the `.env` file.

```fish
rm .env
```

## Advanced: Encrypt secrets in AWS Secrets Manager with AWS KMS customer managed keys (CMK)

AWS secrets manager encrypts all secrets stored in it via keys owned and managed by AWS (Encryption key: `aws/secretsmanager`). For security and compliance reasons you may want to use your own keys to encrypt secrets.

<Note>
  Phase Console supports syncing secrets to AWS Secrets Manager and encrypting
  them via a customer managed (CMK) `Symmetric` key with `SYMMETRIC_DEFAULT` key
  spec.
</Note>

1. Get the AWS KMS CMK key ARN

```fish
aws kms list-keys
```

2. Create an IAM policy that allows Phase to Encrypt secrets with your key.

You can use the following IAM policy template while creating IAM user credentials:

```json
{
  "Version": "2012-10-17",
  "Statement": [
    {
      "Sid": "AllowSecretsManagerAccess",
      "Effect": "Allow",
      "Action": [
        "secretsmanager:GetSecretValue",
        "secretsmanager:DescribeSecret",
        "secretsmanager:ListSecrets",
        "secretsmanager:PutSecretValue",
        "secretsmanager:CreateSecret",
        "secretsmanager:DeleteSecret",
        "secretsmanager:TagResource",
        "secretsmanager:UpdateSecret"
      ],
      "Resource": "*"
    },
    {
      "Sid": "AllowKMSEncryption",
      "Effect": "Allow",
      "Action": [
        "kms:Encrypt",
        "kms:Decrypt",
        "kms:ReEncrypt*",
        "kms:GenerateDataKey*",
        "kms:DescribeKey"
      ],
      "Resource": "<ARN OF YOUR KMS CMK>"
    }
  ]
}
```
