import { Tag } from '@/components/Tag'

export const description = 'Integrate Phase with Hashicorp Nomad'

<Tag variant="small">INTEGRATE</Tag>

# Hashicorp Nomad

You can use Phase to inject secrets to your application running on Hashicorp Nomad during runtime.

## Prerequisites

- Have signed up for the [Phase Console](https://console.phase.dev) and created an App
- Get a [`PHASE_SERVICE_TOKEN`](/console/tokens#service-tokens)

## Nomad task

In order to deploy secrets to our application running in a Nomad cluster we will use the Phase CLI Docker image, available at [Docker Hub](https://hub.docker.com/r/phasehq/cli/tags). We will configure this as a [prestart](https://developer.hashicorp.com/nomad/docs/job-specification/lifecycle) container which will authenticate with the Phase service using the `PHASE_SERVICE_TOKEN`, fetch secrets and write them to a shared directory which our `run-alpine` task will use to consume the secrets.

Here's an example task `my-application-deployment.nomad`:

```hcl
job "my-application-deployment" {
  datacenters = ["dc1"]

  group "app" {
    ephemeral_disk {
      size = 200
      sticky = true
      migrate = true
    }

    task "fetch-secrets" {
      driver = "docker"

      config {
        // Set a specific version of the Phase CLI Docker image
        image = "phasehq/cli:<VERSION>"
        command = "/bin/sh"
        args = [
          "-c",
          "phase secrets export --app your-phase-application --env production > /alloc/secrets"
        ]
      }

      env {
        PHASE_SERVICE_TOKEN = "<your-phase-service-token>"
        // For self hosted Phase instances
        // PHASE_HOST = "https://phase.example.com"
      }

      lifecycle {
        hook = "prestart"
        sidecar = false
      }

      resources {
        cpu    = 100
        memory = 128
      }
    }

    task "run-alpine" {
      driver = "docker"

      config {
        image = "alpine:latest"
        command = "/bin/sh"
        args = [
          "-c",
          "set -a && . /alloc/secrets && set +a && printenv && sleep infinity"
        ]

      }

      resources {
        cpu    = 100
        memory = 128
      }
    }
  }
}
```

To deploy:

```
nomad job run my-application-deployment.nomad
```
