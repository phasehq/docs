import { Tag } from '@/components/Tag'

export const description = 'Integrate Phase with Hashicorp Nomad'

<Tag variant="small">INTEGRATE</Tag>

# Hashicorp Nomad

You can use Phase to inject secrets to your application running on Hashicorp Nomad during runtime.

<Warning>
  When secret syncing is enabled, secrets stored inside Phase will be treated as
  a source of truth. Any secrets on target service will be overwritten /
  deleted. Please import your secrets in Phase before continuing.
</Warning>

### Prerequisites

- Sign up for the [Phase Console](/quickstart) and [create an App](/console/apps#create-an-app).
- Enable Server-side Encyrption (SSE) for the App from the [Settings](/console/apps#settings) tab.

## Optional: Import exiting secrets from Hashicorp Nomad to Phase

```fish
nomad var get -out json <PATH_TO_YOUR_NOMAD_VARIABLE> | \
jq -r '.Items | to_entries | map("\(.key)=\(.value | tostring)") | .[]' > .env && \
phase secrets import .env --env prod --app my-application
```

## Step 1: Authentication

1. Create a ACL policy that will allow the Phase Console to write secrets to your Nomad cluster.

While choosing a path in your policy you may want to consider the following Nomad variable path conventions.

- Use `nomad/jobs` for access in all tasks in all jobs
- Use `nomad/jobs/my-nomad-job` for access from all tasks in this job
- Use `nomad/jobs/my-nomad-job/web` for access from all tasks in a specific task group
- Use `nomad/jobs/my-nomad-job/web/http` for access from a specific task

[Learn more about Nomad Variables](https://developer.hashicorp.com/nomad/tutorials/variables)

Below is a sample policy that you can use to deploy secrets to any path under `nomad/jobs/my-nomad-job*` in the `default` namespace.

Create the ACL Policy via the Nomad CLI:

Create a `policy.hcl`

```hcl
namespace "default" {
  policy = "write"

  variables {
    path "nomad/jobs/my-nomad-job*" {
      capabilities = ["write"]
    }
  }
}
```

Apply the policy:

```fish
nomad acl policy apply phase-console-nomad-secret-sync policy.hcl
```

Create the ACL Policy

/ui/access-control/policies/new

Access Control -> Policies -> + Create Policy

![nomad-ui-policy-create](/assets/images/platform-integrations/hashicorp/nomad/nomad-ui-policy-create.png)

create the token

```
nomad acl token create -name='phase-console-nomad-sync-token' -policy='phase-console-nomad-secret-sync'
```

On the cli, you should see:

```
Accessor ID  = 0d39be90-c87a-62dd-66cb-925ddf6086d1
Secret ID    = 6a5bd881-33d4-0199-6276-f8e4816d8b87 ðŸ‘ˆ
Name         = phase-console-nomad-sync-token
Type         = client
Global       = false
Create Time  = 2024-05-13 08:06:15.401142664 +0000 UTC
Expiry Time  = <none>
Create Index = 5285
Modify Index = 5285
Policies     = [phase-console-nomad-secret-sync]

Roles
<none>
```

#### Create a new Client Token

/ui/access-control/tokens/new

![nomad-ui-token-create](/assets/images/platform-integrations/hashicorp/nomad/nomad-ui-token-create.png)
