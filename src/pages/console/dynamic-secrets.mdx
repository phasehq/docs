import { Tag } from '@/components/Tag'
import { DocActions } from '@/components/DocActions'

export const description = 'This guide will explain how to work with Dynamic Secrets in Phase'

<Tag variant="small">CONSOLE</Tag>

# Dynamic Secrets

Dynamic Secrets are credentials for third-party services that are *leased* on-demand for a limited time. Leases are tied to a specific account, and can be renewed to extend their validitiy, or revoked manually befor they expire. Dynamic Secrets reduce the attack surface of your secrets by limiting the lifespan of active credentials and ensuring that each user has their own set of credentials. 
Dynamic Secrets can be created manually or automatically through integrations with external systems.

<DocActions /> 

<Note>
 The ability to create and manage Dynamic Secrets is available for organizations with an `Enterprise` tier subscription.
</Note>



## Create a Dynamic Secret

To create a Dynamic Secret, navigate to the "Secrets" tab in the Phase Console, and open a specific Environment. Click on the "Create Dynamic Secret" button to open the creation form. 

<Note>
You need to Enable Server-side Encryption (SSE) for the App from the [Settings](/console/apps#settings) tab to use Dynamic Secrets.
</Note>

![create dynamic secret button](/assets/images/console/dynamic-secrets/create-dynamic-secret-button.png)

Choose a provider, and then fill in the required fields. The required configuration will vary for each provider, but all dynamic secrets will required: 

- **Secret Name**: A unique name for the secret.
- **Description**: A brief description of the secret.
- **Max TTL**: The maximum time-to-live for the secret. This is the maximum duration that the credentials can be leased for. After this time, the credentials will be automatically deleted.
- **Default TTL**: The default time-to-live for the secret. This is the default duration that the credentials will be leased for when they are created. This value must be less than or equal to the Max TTL.
- **Outputs**: This is a mapping of secrets or credentials created on the third-party service, and how they will be mapped to secrets in your Phase Environment.. These fields will vary depending on the provider.

![common config](/assets/images/console/dynamic-secrets/common-config.png)

View the specific instructions for each provider below for provider-specific configuration.


Finally, click "Create Dynamic Secret" to save it. Your secret will now be available in the list of secrets for the Environment. You can update the configuration of the Dynamic Secret at any time by clicking on "Update" next to the secret in the list.

![created secret](/assets/images/console/dynamic-secrets/created-secret.png)

### Supported Providers
- [AWS IAM](aws-iam)

#### AWS IAM

AWS IAM Dynamic Secrets allow you to create temporary AWS credentials that can be used to access AWS services. Each time a credential is generated, a new IAM user is created, and credentials are created for this user. Usernames are unique and contain a `{{random}}` string with a prefix or suffic that you can define.

To create an AWS IAM Dynamic Secret, you will need to provide the following information:

- **Authentication credentials**: You can choose to authenticate using either an IAM Role or Access Keys.
  - If you choose **IAM Role**, you will need to provide the Role ARN and External ID (if applicable).
  - If you choose **Access Keys**, you will need to provide the Access Key ID and Secret Access Key.
- **IAM User template**: A template string used to create unique IAM usernames. The template must include the `{{random}}` variable, which will be replaced with a random string when the user is created. You can also include a prefix or suffix to make the usernames more identifiable.
- **AWS IAM Path**: The path for the IAM user. This is optional and defaults to `/phase/<org_name>/<app_name>/<environment_name>/<secret_path>`.
- **AWS Policy ARNs**: A list of IAM policy ARNs to attach to the user. You can attach multiple policies by separating them with commas.
- **AWS IAM Groups**: A list of IAM groups to add the user to. You can add the user to multiple groups by separating them with commas.
- **IAM User Permission Boundary ARN**: An optional ARN of the policy to use as a permission boundary for the user.

![aws iam config](/assets/images/console/dynamic-secrets/aws-iam-config.png)


## Leasing credentials

To lease credentials for a Dynamic Secret, click on the **Generate* button for the secret. Provide a name for the lease, a TTL in seconds, and click "Generate". The TTL must be less than or equal to the Max TTL specified in the Dynamic Secret configuration. 

![generate lease 1](/assets/images/console/dynamic-secrets/generate-lease-1.png)

The generated credentials will be displayed, along with the lease ID and lease expiration time. Make sure to copy the credentials, as they will not be displayed again.

![generate lease 2](/assets/images/console/dynamic-secrets/generate-lease-2.png)

## Delete a Dynamic Secret

To delete a Dynamic Secret, click on the **Delete** button next to the secret in the list. Confirm the deletion in the dialog that appears. This will delete the Dynamic Secret and all associated leases and credentials.

![delete secret](/assets/images/console/dynamic-secrets/delete-dynamic-secret.png)


## Managing Leases

To view and manage leases for a Dynamic Secret, click on the **Leases** button for the secret. 

![view leases button](/assets/images/console/dynamic-secrets/leases-button.png)

This will open a list of all active leases for the secret, along with their lease ID, name, creation time, expiration time, and status.

![leases list](/assets/images/console/dynamic-secrets/leases-list.png)

### Renew a Lease

To renew a lease, click on the **Renew** button next to the lease in the list. Provide a new TTL in seconds, and click "Renew". The new TTL must be less than or equal to the Max TTL specified in the Dynamic Secret configuration. Note that this will reset the expiry time based on the newly selected TTL.

![renew lease](/assets/images/console/dynamic-secrets/renew-lease.png)

### Revoke a Leases

To revoke a lease, click on the **Revoke** button next to the lease in the list. Confirm the revocation in the dialog that appears. This will immediately delete the credentials associated with the lease and mark the lease as revoked.

![revoke lease](/assets/images/console/dynamic-secrets/revoke-lease.png)

