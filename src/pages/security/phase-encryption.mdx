export const description = 'Phase Encryption overview'

# Phase Console Crypto

## Client-side key generation

![](/assets/phase-console-crypto.svg)

1. **24 Word Account Recovery**: Generated using to [BIP39](https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki) Bitcoin spec.

Note on BIP39: Since the native BIP39 implementations use PBKDF2 with SHA512 with 2048 iterations. Which out of the box, for our use cases provide insufficient protection. We instead use a two staged key derivation process where we only use BIP39 for the process of recovery phrase generation and use libsodium's strong implementation of [Argon2ID 1.3](https://doc.libsodium.org/password_hashing#argon2) for key derivation.

2. **Account Seed**: The mnemonic phrase is securely hashed with a memory hardened key derivation function [Argon2ID](https://en.wikipedia.org/wiki/Argon2) `crypto_pwhash_ALG_ARGON2ID13` with the `crypto_pwhash_OPSLIMIT_SENSITIVE` & `crypto_pwhash_MEMLIMIT_SENSITIVE` params to generate a single high entropy 32 byte / 256 bit seed.

3. This seed is then passed to libsodium's `crypto_kdf_derive_from_key` function with a unique `context` and `id` to create two 32 byte / 256 bit sub keys from a single high entropy seed. [More at: libsodium docs](https://doc.libsodium.org/key_derivation#deriving-keys-from-a-single-high-entropy-key)

- **Symmetric Key**: Used to Encrypt all sensitive account data / keys. eg. App seed
- **Signing Key Seed**: Used to generate a [ED25519](https://www.cryptopp.com/wiki/Ed25519) key pair that's used to sign challenges. A public key known as the **Account Identity Key** is generated from the **Signing Key Seed** using the `crypto_sign_seed_keypair` in libsodium, this key is stored on the Phase Console backend. (In the future this key can also be used to securely share data from one account to another using X25519.) eg. To securely validate 24 word account recovery via a challenge-response scheme, while trying to log into a new device.

4. **Device Vault Key** - Is securely derived by hashing a user supplied 16 character local device password known as the `sudo` password with [Argon2ID](https://en.wikipedia.org/wiki/Argon2) `crypto_pwhash_ALG_ARGON2ID13` with `crypto_pwhash_OPSLIMIT_MODERATE` & `crypto_pwhash_MEMLIMIT_MODERATE` in the Phase Console and it's used to Encrypt any sensitive user data or wrapping keys with [XChaChaPoly1305](https://doc.libsodium.org/secret-key_cryptography/aead/chacha20-poly1305) before writing them to local device storage.

<Note>
  The **24 Word Account Recovery**, **Account Seed**, **Symmetric Keys** or
  **Signing Keys** are generated deterministically with client-sided crypto on
  your machine and never transmitted or stored on Phase backend infrastructure.
</Note>

---

## App keys & secret generation

1. **App Seed**: A random high entropy 32 byte / 256 bit seed is generated using libsodium's `crypto_kdf_keygen()`. The seed is then passed to `crypto_kx_seed_keypair()` which returns a X25519 public key (appID) and private key. App Seed is Encrypted with [XChaChaPoly1305](https://doc.libsodium.org/secret-key_cryptography/aead/chacha20-poly1305) and stored on the Phase Console backend.

2. **App Token**: A random high entropy 32 byte / 256 bit token generated by libsodium's `crypto_kdf_keygen()`. This token is used to by Phase nodes to authenticate with Phase KMS services.

3. **App Shares**: The private key returned by `crypto_kx_seed_keypair()` is split into two shares (_App Share0_ & _App Share1_) via _t=n_ (Threshold for quorum = Number of shares) an XOR based [secret sharing](https://en.wikipedia.org/wiki/Secret_sharing) scheme. _Share0_ is a random high entropy 32 byte / 256 bit offsetKey generated via libsodium's `crypto_kdf_keygen()`, its equal in length to the App private key. _Share1_ is computed by XORing the app private key with the offsetKey.

```python
# share construction
share0 = offSetKey
share1 = privKey ⊕ offsetKey
# private key reconstruction
privkey = share0 ⊕ share1
```

4. **Wrapping Key**: A random high entropy 32 byte / 256 bit key generated by libsodium's `crypto_kdf_keygen()`. Used to wrap / unwrap **App Share1** with [XChaChaPoly1305](https://doc.libsodium.org/secret-key_cryptography/aead/chacha20-poly1305) encryption.

5. The above keys are encoded in hex and combined to create the [`APP_ID`](/security/phase-encryption#app-id) [`APP_SECRET`](/security/phase-encryption#app-secret).

---

## Keys rotation & revocation

1. `APP_SECRET` rotation:

- How are app keys rotated?
  - New key shares
  - New app token
  - New app wrap key
  - New wrapped key
  - New app secret
  - Revoking old app token / wrapped key from Phase KMS
- Where are app keys stored?
  - Keyring on device
  - encrypted app keyring on backend
    - Encrypted with account symmetric key (XChaCha-Poly1305)
- App secret?
  - Why?
  - What is it for?
  - Format
- App Id?
  - Why?
  - What is it for?
  - Format

## Data encryption (SDKs)

![](/assets/phase-sdk-crypto.svg)

- public key from `APP_ID`
- Ephemeral key pair
  - Why?
  - How is it generated? `crypto_kx_keypair`
- One time symmetric key
  - Diffie-Hellman keys
- Encryption
  - XChaCha-Poly1305
  - IV?
  - Output format

## Data decryption (SDKs)

- App token from ciphertext → fetch wrapped share from Phase KMS
  - Why?
  - How?
- Unwrapping wrapped share → share1
- Combining key shares to reconstruct private key
- Parsing public key from ciphertext
- Diffie Hellman with app private key and ciphertext public key → Symmetric key
- Decrypting with XChaCha-Poly1305

<br></br>
<Row>
  <Col>

    ## Phase encrypted data {{ tag: 'ENCRYPTED',  label: 'Secure encrypted information' }}

    <Properties>
      <Property name="ph" type="plain text">
        Helps identify data encrypted with Phase SDKs
      </Property>
      <Property name="version" type="plain text">
        Helps identify version of data encrypted with Phase
      </Property>
            <Property name="ephPublicKey" type="hex">
        An ephemeral X25519 public key used to derive XChaCha20 shared secret
      </Property>
            <Property name="ciphertext" type="base64">
        XChaCha20-Poly1305 encrytped data
      </Property>
            <Property name="nonce" type="base64">
        A randomly generated 192bit initialization vector
      </Property>
            <Property name="tag" type="plain text">
        An optional user supplied string
      </Property>

    </Properties>

  </Col>
  <Col sticky>

    ```
    -> ph:version:ephPublicKey:ciphertext+nonce:tag
    ```

  </Col>
</Row>

---

<Row>
  <Col>

    ## `APP_ID` {{ tag: 'PUBLIC',  label: 'Phase Applicaton ID' }}

    <Properties>
      <Property name="phID" type="plain text">
        Helps identify Phase SDK appID
      </Property>
      <Property name="version" type="plain text">
        Helps identify Phase SDK appID version
      </Property>
      <Property name="appID" type="hex">
        X25519 public application public key
      </Property>

    </Properties>

  </Col>
  <Col sticky>

    ```
    -> phApp:version:appID
    ```

  </Col>
</Row>

---

<Row>
  <Col>

    ## `APP_SECRET` {{ tag: 'SECRET', label: 'Phase AppSecret' }}

    <Properties>
      <Property name="pss" type="plain text">
        Helps identify Phase SDK secret
      </Property>
      <Property name="version" type="plain text">
        Helps identify Phase SDK `APP_SECRET` version
      </Property>
      <Property name="appToken" type="hex">
        Used to authenticate to the Phase Key Management Service (KMS)
      </Property>
      <Property name="share0" type="hex">
        Share0 of the application private key
      </Property>
      <Property name="wrapKey" type="hex">
         A 32 bytes symmetric key used to unwrap share1
      </Property>

    </Properties>

  </Col>
  <Col sticky>

    ```
    -> pss:version:appToken:share0:wrapKey
    ```

  </Col>
</Row>
