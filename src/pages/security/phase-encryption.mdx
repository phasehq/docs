export const description =
  'Phase Encryption overview - What is encrypted, where is it stored?'

# Phase Crypto

<Note>
## TL;DR
### What is encrypted, where is it stored?

Keys generated / stored locally:

- **Account Identity Key** - Public Key - Plain Text
- **24 Word Account Recovery Key** - Encrypted with `sudo` password
- **Symmetric Key** - Encrypted with `sudo` password
- **Signing Key Seed** - Encrypted with `sudo` password

Keys stored on the Phase Console backend:

- **Account Identity Key** - Public Key - Plain Text
- **APP_ID** - Public Key - Plain Text
- **App Seed** - Encrypted with **Symmetric Key**
- **Share1** - Encrypted with **Wrapping Key**

</Note>

![](/assets/phase-console-crypto.svg)

## Phase Console - Client-side key generation

1. **24 Word Account Recovery**: Generated using to [BIP39](https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki) Bitcoin spec.

Note on BIP39: Since the native BIP39 implementations use `PBKDF2` with `SHA512` with 2048 iterations for key derivation, which for our use cases provide insufficient protection. We instead use a two staged key derivation process where we only use BIP39 for recovery phrase generation and use libsodium's implementation of [Argon2ID 1.3](https://doc.libsodium.org/password_hashing#argon2) for key derivation.

2. **Account Seed**: The **24 Word Account Recovery** is securely hashed with [`Argon2ID`](https://en.wikipedia.org/wiki/Argon2) with libsodium's `crypto_pwhash_ALG_ARGON2ID13()`, `crypto_pwhash_OPSLIMIT_SENSITIVE` & `crypto_pwhash_MEMLIMIT_SENSITIVE` params to generate a single high entropy 256 bit **Account Seed**.

3. **Account Sub-Keys**: The **Account Seed** is then passed to [libsodium](https://doc.libsodium.org/key_derivation#deriving-keys-from-a-single-high-entropy-key)'s `crypto_kdf_derive_from_key()` with a unique `ctx` (context) and `subkey_id` to create the two following 256 bit **Account Sub-Keys** from a single high entropy seed:

- **_Symmetric Key_**: Is used to encrypt all sensitive account data / keys in the Phase Console client. eg. [App seed](/security/phase-encryption#app-keys-and-secret-generation)
- **_Signing Key Seed_**: Is used to generate a [`ED25519`](https://www.cryptopp.com/wiki/Ed25519) key pair that's used to sign challenges. A public key known as the **Account Identity Key** is generated from the **_Signing Key Seed_** using the `crypto_sign_seed_keypair()` in libsodium, this public key is stored on the Phase Console backend. eg. To securely validate 24 word account recovery via a challenge-response scheme, while trying to log into a new device. (In the future this key can also be used to securely share data from one user to another using `X25519`)

4. **Device Vault Key** - Is securely derived by hashing a user supplied local device password (which must be >= 16 characters) known as the `sudo` password with [`Argon2ID`](https://en.wikipedia.org/wiki/Argon2) `crypto_pwhash_ALG_ARGON2ID13()` with `crypto_pwhash_OPSLIMIT_MODERATE` & `crypto_pwhash_MEMLIMIT_MODERATE` in the Phase Console and it's used to encrypt any sensitive user data or wrapping keys with [`XChaChaPoly1305`](https://doc.libsodium.org/secret-key_cryptography/aead/chacha20-poly1305) before writing them to local device storage.

---

## App keys & secret generation

1. **App Seed**: A random high entropy 32 byte / 256 bit seed is generated using libsodium's `crypto_kdf_keygen()`. The seed is then passed to `crypto_kx_seed_keypair()` which returns a `X25519` public key (appID) and private key. App Seed is Encrypted with [`XChaChaPoly1305`](https://doc.libsodium.org/secret-key_cryptography/aead/chacha20-poly1305) and stored on the Phase Console backend.

2. **App Token**: A random high entropy 32 byte / 256 bit token generated by libsodium's `crypto_kdf_keygen()`. This token is used to by Phase nodes to authenticate with Phase KMS services.

3. **App Shares**: The private key returned by `crypto_kx_seed_keypair()` is split into two shares (_App Share0_ & _App Share1_) via _t=n_ (Threshold for quorum = Number of shares) an XOR based [secret sharing](/security/cryptography#secret-sharing) scheme. _Share0_ is a random high entropy 32 byte / 256 bit offsetKey generated via libsodium's `crypto_kdf_keygen()`, its equal in length to the App private key. _Share1_ is computed by XORing the app private key with the offsetKey.

```python
# share construction
share0 = offSetKey
share1 = privKey ⊕ offsetKey
wrappedShare = encrypt(wrappingKey, share1)

# private key reconstruction
share1 = decrypt(wrappingKey, wrappedShare)
privKey = share0 ⊕ share1
```

4. **Wrapping Key**: A random high entropy 32 byte / 256 bit key generated by libsodium's `crypto_kdf_keygen()`. Used to wrap / unwrap **App Share1** with [`XChaChaPoly1305`](https://doc.libsodium.org/secret-key_cryptography/aead/chacha20-poly1305) encryption.

5. The above keys are encoded in hex and combined to create the [`APP_ID`](/security/phase-encryption#app-id) [`APP_SECRET`](/security/phase-encryption#app-secret).

---

## Key rotation & revocation

### `APP_SECRET` revocation:

- A user can revoke their app keys my deleting an individual key pair or an app in the Phase Console. The encrypted share0 that is stored on the Phase KMS network will be deleted, this process can take up to 60 seconds.

### `APP_SECRET` rotation:

- A user can choose to rotate their [`APP_SECRET`](/security/phase-encryption#app-secret) in case they believe it could have been compromised. eg. Checked in version control, in possession by an adversary etc. The Phase Console will create and deploy new [`APP_SECRET`](/security/phase-encryption#app-secret) by rotating **App Token**, **App Shares** and **Wrapping Key**.
- The encrypted share0 that is stored on the Phase KMS network will be updated, this process can take up to 60 seconds.
- Its important to keep in mind that a compromised [`APP_SECRET`](/security/phase-encryption#app-secret) is outside the scope of the threat model that Phase operates on top of. If an attacker has access to your [`APP_SECRET`](/security/phase-encryption#app-secret) and knowledge of the Phase encryption system, its theoretically possible to reconstruct the **App Seed**. To mitigate such a breach will require significant efforts on your part to re-encrypt existing data with new keys.
- To prevent such mishaps, please consider using a end-to-end encrypted secret management service like [Infisical](https://infisical.com/).

---

## Data encryption (SDKs)

![](/assets/phase-sdk-crypto.svg)

### Encryption

1. Create a ephemeral `X25519` key pair with libsodium's `crypto_kx_keypair()` function.
2. Create a `sessionKey` a 256 bit symmetric key via the `X25519` Elliptic Curve Diffie-Hellman key exchange with the public key from [`APP_ID`](/security/phase-encryption#app-id) and ephemeral key pair.
3. Use the `sessionKey` to encrypt data with libsodium's `crypto_aead_xchacha20poly1305_ietf_encrypt()`.
4. Return Phase encrypted data in the [`ph:`](/security/phase-encryption#phase-encrypted-data) format.

### Decryption

1. Authenticate to the Phase KMS via the **App Token** from the `APP_SECRET` and fetch the encrypted share1.
2. Reconstruct the share0 + share1 to assembly **App Seed**.
3. Recreate the `sessionKey` via the `X25519` Elliptic Curve Diffie-Hellman key exchange from the `ephPublicKey` and the **App Seed**.
4. Use the `sessionKey` to decrypt data with libsodium's `crypto_aead_xchacha20poly1305_ietf_encrypt()`.
5. Return data

---

## Data Structure

<Row>
  <Col>

    ## Phase encrypted data {{ tag: 'ENCRYPTED',  label: 'Secure encrypted information' }}

    <Properties>
      <Property name="ph" type="plain text">
        Helps identify data encrypted with Phase SDKs
      </Property>
      <Property name="version" type="plain text">
        Helps identify version of data encrypted with Phase
      </Property>
            <Property name="ephPublicKey" type="hex">
        An ephemeral X25519 public key used to derive XChaCha20 shared secret
      </Property>
            <Property name="ciphertext" type="base64">
        XChaCha20-Poly1305 encrytped data
      </Property>
            <Property name="nonce" type="base64">
        A randomly generated 192bit initialization vector
      </Property>
            <Property name="tag" type="plain text">
        An optional user supplied string
      </Property>

    </Properties>

  </Col>
  <Col sticky>

    ```
    -> ph:version:ephPublicKey:ciphertext+nonce:tag
    ```

  </Col>
</Row>

---

<Row>
  <Col>

    ## `APP_ID` {{ tag: 'PUBLIC',  label: 'Phase Applicaton ID' }}

    <Properties>
      <Property name="phID" type="plain text">
        Helps identify Phase SDK appID
      </Property>
      <Property name="version" type="plain text">
        Helps identify Phase SDK appID version
      </Property>
      <Property name="appID" type="hex">
        X25519 public application public key
      </Property>

    </Properties>

  </Col>
  <Col sticky>

    ```
    -> phApp:version:appID
    ```

  </Col>
</Row>

---

<Row>
  <Col>

    ## `APP_SECRET` {{ tag: 'SECRET', label: 'Phase AppSecret' }}

    <Properties>
      <Property name="pss" type="plain text">
        Helps identify Phase SDK secret
      </Property>
      <Property name="version" type="plain text">
        Helps identify Phase SDK `APP_SECRET` version
      </Property>
      <Property name="appToken" type="hex">
        Used to authenticate to the Phase Key Management Service (KMS)
      </Property>
      <Property name="share0" type="hex">
        Share0 of the application private key
      </Property>
      <Property name="wrapKey" type="hex">
         A 32 bytes symmetric key used to unwrap share1
      </Property>

    </Properties>

  </Col>
  <Col sticky>

    ```
    -> pss:version:appToken:share0:wrapKey
    ```

  </Col>
</Row>
