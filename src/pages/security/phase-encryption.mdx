import { Tag } from '@/components/Tag'

export const description =
  'Phase Cryptography is the architecture used to generate encryption keys, secure keys for storage / transmission over the network and perform encryption or decryption operations.'

<Tag variant="small">SECURITY</Tag>

# Phase Cryptography

Phase Cryptography is the architecture used to generate encryption keys, secure keys for storage / transmission over the network and perform encryption or decryption operations.
Keys are generated or derived in the Phase console client-side, and encrypted before being stored either on disk within your browser, or on our backend.
The [SDKs](/sdks) use this cryptographic architecture to encrypt and decrypt data in your applications.

![Phase Cryptography](/assets/phase-console-crypto.svg)

<div className="text-center italic">
  A high level view of the Phase Cryptography architecture
</div>

## Account keyring

Each Phase account is created with an Account Keyring on signup, which comprises a an [`XChaCha-Poly1305`](https://doc.libsodium.org/secret-key_cryptography/aead/chacha20-poly1305) symmetric key and a [`ED25519`](https://www.cryptopp.com/wiki/Ed25519) signing keypair.

An Account Keyring is generated as follows:

### 1. Account Recovery phrase

The Account Recovery phrase allows you to derive your Account Keyring securely when logging in on a new device or browser.

A **24-word mnemonic** phrase is generated using the [BIP39](https://github.com/bitcoin/bips/blob/master/bip-0039.mediawiki) Bitcoin spec.

<Note>
  The native BIP39 implementations use `PBKDF2` with `SHA512` with 2048
  iterations for key derivation, which for our use case does not provide
  sufficient protection. We instead use a two-staged key derivation process
  where we only use BIP39 for recovery phrase generation and use libsodium's
  implementation of [Argon2ID
  1.3](https://doc.libsodium.org/password_hashing#argon2) for key derivation.
</Note>

### 2. Account Seed

The Account Seed is the root source of entropy used to derive all keys in the Account Keyring.

The **24 Word Account Recovery** is securely hashed with [`Argon2ID`](https://en.wikipedia.org/wiki/Argon2) using libsodium's `crypto_pwhash` and the following parameters:

- `crypto_pwhash_OPSLIMIT_SENSITIVE`
- `crypto_pwhash_MEMLIMIT_SENSITIVE`

### 3. Account Keys

Account Keys are used to secure Account and App data, and validate your identity when logging in to a new device.

The **Account Seed** is passed to [libsodium](https://doc.libsodium.org/key_derivation#deriving-keys-from-a-single-high-entropy-key)'s `crypto_kdf_derive_from_key()`
with a unique `ctx` (context) and `subkey_id` to create the two following 256 bit **Account Keys** from a single high entropy seed:

- **_Symmetric Key_**: Used to encrypt all sensitive account data / keys in the Phase Console client. eg. [App seed](/security/phase-encryption#app-keys-and-secret-generation)
- **_Signing Key Seed_**: Is used to generate a [`ED25519`](https://www.cryptopp.com/wiki/Ed25519) key pair that's used to sign challenges.
  A public key known as the **Account Identity Key** is generated from the **_Signing Key Seed_** using the `crypto_sign_seed_keypair()` in libsodium.
  This public key is stored on the Phase Console backend to cryptographically validate an Account Recovery phrase while trying to log into a new device.
  (In the future this key can also be used to securely share data from one user to another using `X25519`)

### 4. Device Vault Key

The Device Vault Key is derived from a user-supplied password, and is used to encrypt the Account Keyring in your browser.

It is derived by hashing a user-supplied local device password known as the `sudo` password with [`Argon2ID`](https://en.wikipedia.org/wiki/Argon2) with the following parameters:

- `crypto_pwhash_OPSLIMIT_MODERATE`
- `crypto_pwhash_MEMLIMIT_MODERATE`

The Account Keyring is encrypted and decrypted with the Device Vault Key using [`XChaCha-Poly1305`](https://doc.libsodium.org/secret-key_cryptography/aead/chacha20-poly1305)

---

## App keys

App keys are used by the [Phase SDKs](/sdks) to encrypt and decrypt data in your applications. App keys are generated as follows:

### 1. App Seed

A random high entropy 32 byte / 256 bit seed is generated using libsodium's `crypto_kdf_keygen()`.
For storage, the App Seed is Encrypted with [`XChaCha-Poly1305`](https://doc.libsodium.org/secret-key_cryptography/aead/chacha20-poly1305) using the Account Keyring's symmetric key.
The encrypted seed is stored on the Phase Console backend.

### 2. Key derivation from seed

The seed is passed to `crypto_kx_seed_keypair()` which returns a `X25519` public / private keypair.

### 2. App Token

A random high entropy 32 byte / 256 bit token generated by libsodium's `crypto_kdf_keygen()`.
This token is used to by Phase SDKs to authenticate with Phase KMS services.

The App Token is sent as an `Authorization` header to the Phase KMS in the format `Bearer <app_token>`. The App Token is unique for a given `APP_SECRET`. When the `APP_SECRET` is rotated, a new App token is generated.

### 3. Wrapping Key

A random high entropy 32 byte / 256 bit key generated by libsodium's `crypto_kdf_keygen()`. Used to wrap / unwrap **App Share1** with [`XChaCha-Poly1305`](https://doc.libsodium.org/secret-key_cryptography/aead/chacha20-poly1305) encryption.

### 4. App Key Shares

The private key returned by `crypto_kx_seed_keypair()` is split into two shares, `App Share0` & `App Share1` via a threshold XOR based [secret sharing](/security/cryptography#secret-sharing) scheme.
`Share0` is a random high entropy 32 byte / 256 bit offset key generated via libsodium's `crypto_kdf_keygen()`.
`Share1` is computed by computing the XOR of the App private key and the offset key.

Example:

```python
# share construction
share0 = offSetKey
share1 = privKey ⊕ offsetKey
wrappedShare = encrypt(wrappingKey, share1)

# private key reconstruction
share1 = decrypt(wrappingKey, wrappedShare)
privKey = share0 ⊕ share1
```

---

## Key rotation & revocation

### `APP_SECRET` revocation:

- A user can revoke their App keys my deleting an individual key pair or an App in the Phase Console.
  The encrypted `Share0` that is stored on the Phase KMS network will be deleted. This process can take up to 60 seconds.

### `APP_SECRET` rotation:

- A user can choose to rotate their [`APP_SECRET`](/security/phase-encryption#app-secret) if they believe it has been leaked or compromised.
  The Phase Console will create and deploy new [`APP_SECRET`](/security/phase-encryption#app-secret) by rotating **App Token**, **App Shares** and **Wrapping Key**.
- The encrypted `Share0` that is stored on the Phase KMS network will be updated. This process can take up to 60 seconds.

---

## Data encryption (SDKs)

All encryption and decryption operations are performed using [`XChaCha-Poly1305`](https://doc.libsodium.org/secret-key_cryptography/aead/chacha20-poly1305).
Each encryption operation uses a unique symmetric key derived using a key-exchange algorithm, and a random nonce.

![](/assets/phase-sdk-crypto.svg)

### Encryption

1. Create an ephemeral `X25519` key pair with libsodium's `crypto_kx_keypair()` utility.
2. Create a 256 bit symmetric `sessionKey` via the `X25519` Elliptic Curve Diffie-Hellman key exchange algorithm with the public key from [`APP_ID`](/security/phase-encryption#app-id) and ephemeral key pair.
3. Use the `sessionKey` to encrypt data with libsodium's `crypto_aead_xchacha20poly1305_ietf_encrypt()`.
4. Return Phase encrypted data in the [`ph:`](/security/phase-encryption#phase-encrypted-data) format.

### Decryption

1. Authenticate to the Phase KMS via the **App Token** from the `APP_SECRET` and fetch the encrypted `Share1`.
2. Reconstruct the `Share0` + `Share1` to assemble the App private key.
3. Derive the `sessionKey` via the `X25519` Elliptic Curve Diffie-Hellman key exchange algorithm from the `ephPublicKey` and the App private key.
4. Use the `sessionKey` to decrypt data with libsodium's `crypto_aead_xchacha20poly1305_ietf_decrypt()`.
5. Return plaintext data

---

## Data Structure

<Row>
  <Col>

    ## Phase encrypted data {{ tag: 'ENCRYPTED',  label: 'Secure encrypted information' }}

    <Properties>
      <Property name="ph" type="plain text">
        Helps identify data encrypted with Phase SDKs
      </Property>
      <Property name="version" type="plain text">
        Helps identify version of data encrypted with Phase
      </Property>
            <Property name="ephPublicKey" type="hex">
        An ephemeral X25519 public key used to derive XChaCha20 shared secret
      </Property>
            <Property name="ciphertext" type="base64">
        XChaCha20-Poly1305 encrytped data
      </Property>
            <Property name="nonce" type="base64">
        A randomly generated 192bit initialization vector
      </Property>
            <Property name="tag" type="plain text">
        An optional user supplied string
      </Property>

    </Properties>

  </Col>
  <Col sticky>

    ```
    -> ph:version:ephPublicKey:ciphertext+nonce:tag
    ```

  </Col>
</Row>

---

<Row>
  <Col>

    ## `APP_ID` {{ tag: 'PUBLIC',  label: 'Phase Applicaton ID' }}

    <Properties>
      <Property name="phID" type="plain text">
        Helps identify Phase SDK appID
      </Property>
      <Property name="version" type="plain text">
        Helps identify Phase SDK appID version
      </Property>
      <Property name="appID" type="hex">
        X25519 public application public key
      </Property>

    </Properties>

  </Col>
  <Col sticky>

    ```
    -> phApp:version:appID
    ```

  </Col>
</Row>

---

<Row>
  <Col>

    ## `APP_SECRET` {{ tag: 'SECRET', label: 'Phase AppSecret' }}

    <Properties>
      <Property name="pss" type="plain text">
        Helps identify Phase SDK secret
      </Property>
      <Property name="version" type="plain text">
        Helps identify Phase SDK `APP_SECRET` version
      </Property>
      <Property name="appToken" type="hex">
        Used to authenticate to the Phase Key Management Service (KMS)
      </Property>
      <Property name="share0" type="hex">
        Share0 of the application private key
      </Property>
      <Property name="wrapKey" type="hex">
         A 32 bytes symmetric key used to unwrap share1
      </Property>

    </Properties>

  </Col>
  <Col sticky>

    ```
    -> pss:version:appToken:share0:wrapKey
    ```

  </Col>
</Row>

## Key storage

Keys generated / stored locally:

- **Account Identity Key**
- **24 Word Account Recovery Key** <Tag color="emerald">ENCRYPTED</Tag>
- **Symmetric Key** <Tag color="emerald">ENCRYPTED</Tag>
- **Signing Key Seed** <Tag color="emerald">ENCRYPTED</Tag>

Keys stored on the Phase Console backend:

- **Account Identity Key**
- **APP_ID**
- **App Seed** <Tag color="emerald">ENCRYPTED</Tag>
- **Share1** - <Tag color="emerald">ENCRYPTED</Tag>
